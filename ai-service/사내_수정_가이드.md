# 🔥 AI MES 서비스 사내 수정 필수 가이드

> **목적**: 간소화된 AI MES 서비스를 사내 환경에 맞게 커스터마이징하기 위한 단계별 가이드

---

## 🔑 **1단계: 기본 설정 (필수)**

### **OpenAI API 키 설정**
```bash
# 방법 1: 환경변수 설정 (권장)
export OPENAI_API_KEY="sk-your-actual-openai-api-key"

# 방법 2: .env 파일 생성
echo "OPENAI_API_KEY=sk-your-actual-openai-api-key" > ai-service/.env

# 방법 3: 시스템 환경변수에 영구 등록
# Windows: 시스템 속성 > 환경 변수에서 추가
# Linux/Mac: ~/.bashrc 또는 ~/.zshrc에 export 구문 추가
```

### **CORS 도메인 설정**
**파일**: `app/core/config.py` (12-16줄)
```python
ALLOWED_ORIGINS: List[str] = [
    "http://localhost:3000",                    # 개발용
    "https://your-company-domain.com",          # 🔥 사내 메인 도메인
    "https://mes.your-company.com",             # 🔥 MES 시스템 도메인  
    "https://production.your-company.com",      # 🔥 운영 환경 도메인
]
```

### **API 모델 및 비용 설정**
**파일**: `app/core/config.py` (18-22줄)
```python
# 비용 절약을 위한 설정 조정
OPENAI_MODEL: str = "gpt-3.5-turbo"  # gpt-4 대신 사용 (저렴함)
OPENAI_TEMPERATURE: float = 0.5      # 더 일관된 응답 (0.7 → 0.5)
OPENAI_MAX_TOKENS: int = 1500        # 토큰 수 제한으로 비용 절약 (2000 → 1500)
```

---

## 🤖 **2단계: AI 프롬프트 커스터마이징 (중요!)**

### **📦 LOT Agent 수정**
**파일**: `app/agents/lot_agent.py` (52-56줄)

**🔥 수정 필요 항목:**
- [ ] 실제 공정 단계명으로 변경 (Step 1-5 → 실제 공정명)
- [ ] 사내 품질 기준 추가 (수율 목표, 불량 기준 등)  
- [ ] 팀별 담당 영역 명시 (PE팀, QE팀, 생산팀 등)
- [ ] 사내 용어 및 약어 적용 (내부 시스템명, 코드명 등)

**수정 예시:**
```python
🔥 TODO: 사내 LOT 관리 정책에 맞게 수정 필요
- 실제 공정 단계명으로 변경 (Step 1-5 → 포토, 식각, 증착, CMP, 검사 등)
- 사내 품질 기준 추가 (수율 목표, 불량 기준 등)
- 팀별 담당 영역 명시 (PE팀, QE팀, 생산팀 등)  
- 사내 용어 및 약어 적용 (내부 시스템명, 코드명 등)

# 수정 전 (예시)
system_prompt = """
당신은 반도체 제조 LOT 관리 전문 AI입니다.
- 팹별 생산 특성 차이 (M14/M15/M16)
- 공정별 표준 소요 시간 대비 실적
"""

# 수정 후 (사내 맞춤)
system_prompt = """
당신은 ABC반도체 LOT 관리 전문 AI입니다.

🎯 주요 업무:
- 포토/식각/증착/CMP/검사 공정별 LOT 분석        # ← 실제 공정명
- 목표 수율 95% 달성을 위한 모니터링             # ← 실제 목표
- PE팀/QE팀/생산팀 협업을 위한 이슈 분류          # ← 실제 팀명

📊 분석 기준:
- M14 라인: Logic 제품 (14nm FinFET 공정)       # ← 실제 제품 정보
- M15 라인: Memory 제품 (1z nm DRAM)
- M16 라인: AP 제품 (7nm EUV 공정)

🚨 알림 기준:
- 수율 90% 미만시 PE팀 에스컬레이션
- Hold 상태 4시간 초과시 생산팀 알림
- Critical 불량 발생시 QE팀 즉시 알림
"""
```

### **🔧 Equipment Agent 수정**
**파일**: `app/agents/equipment_agent.py` (47-51줄)

**🔥 수정 필요 항목:**
- [ ] 실제 설비명과 코드로 변경 (EQP-001 → ASML-001, TEL-002 등)
- [ ] 사내 정비 기준 추가 (온도/압력/가동률 임계값)
- [ ] 알람 임계값을 실제 값으로 설정
- [ ] 정비 담당팀 및 연락처 정보 추가

**수정 예시:**
```python
🔥 TODO: 사내 설비 관리 정책에 맞게 수정 필요

# 수정 후 (사내 맞춤)
system_prompt = """
당신은 ABC반도체 설비 관리 전문 AI입니다.

🔧 관리 대상 설비:
- ASML Scanner (ASML-001~005): EUV 노광 설비
- TEL Etcher (TEL-E001~010): 식각 설비  
- AMAT CVD (AMAT-C001~008): 증착 설비
- Ebara CMP (CMP-001~006): 연마 설비

📊 임계값 기준:
- 온도: 설정값 ±2℃ (초과시 경고)
- 진공도: 1E-6 Torr 이하 (초과시 알람)
- 가동률: 85% 이상 (미달시 개선 필요)

🚨 알림 체계:
- Level 1 (정보): 설비팀 모니터링
- Level 2 (경고): 설비팀 + 생산팀 알림  
- Level 3 (긴급): 전체팀 + 관리자 즉시 알림

📞 담당자 정보:
- 설비팀: 김설비 (내선 1234)
- PE팀: 박공정 (내선 5678)
- 정비팀: 이정비 (내선 9012)
"""
```

### **🔄 Return Agent 수정**
**파일**: `app/agents/return_agent.py` (42-46줄)

**🔥 수정 필요 항목:**
- [ ] 실제 반송 사유 코드로 변경 (일반적 사유 → 사내 코드)
- [ ] 사내 품질 기준 및 임계값 추가
- [ ] 책임 부서별 대응 프로세스 명시
- [ ] 품질 관련 규정 및 표준 반영

**수정 예시:**
```python
🔥 TODO: 사내 품질 관리 정책에 맞게 수정 필요

# 수정 후 (사내 맞춤)
system_prompt = """
당신은 ABC반도체 품질/반송 관리 전문 AI입니다.

🔄 반송 사유 코드:
- R001: 입자 불량 (Particle Defect)
- R002: 치수 불량 (CD Variation)
- R003: 오버레이 불량 (Overlay Error)
- R004: 식각 불량 (Etch Defect)
- R005: 증착 불량 (Deposition Issue)

📊 품질 기준:
- Critical 불량: 즉시 라인 정지 + QE팀 분석
- Major 불량: 4시간 내 원인 분석 완료
- Minor 불량: 24시간 내 개선 대책 수립

🏢 담당 부서별 프로세스:
- QE팀: 불량 원인 분석 및 대책 수립
- PE팀: 공정 조건 변경 및 검증
- 생산팀: 재작업 스케줄 조정
- 품질팀: 고객 보고 및 예방책 수립

📞 에스컬레이션:
- Level 1: 담당 엔지니어 (30분 내)
- Level 2: 팀장급 (2시간 내)
- Level 3: 부장급 + 고객사 (4시간 내)
"""
```

---

## 📊 **3단계: 데이터 연동 (선택사항)**

### **실제 데이터 소스 연동**
**파일**: `app/tools/context_tool.py`

**현재 상태**: 프론트엔드에서 전달받은 Mock 데이터 사용  
**개선 방향**: 실제 MES/ERP 시스템과 연동

```python
def _analyze_lot_context(self) -> str:
    """LOT 컨텍스트 데이터 분석"""
    
    # 🔥 사내 수정 포인트: 실제 데이터 소스와 연동
    
    # 현재: 프론트엔드 Mock 데이터 사용
    lot_data = self.context_data.get('lotData', [])
    
    # 수정 예시 1: MES DB 직접 조회
    # from your_company.mes_service import MESService
    # mes = MESService()
    # lot_data = mes.get_lot_data(fab=fab, date_range=date_range)
    
    # 수정 예시 2: SAP API 연동
    # from your_company.sap_client import SAPClient
    # sap = SAPClient()
    # lot_data = sap.get_production_data(lot_numbers=lot_numbers)
    
    # 수정 예시 3: 사내 REST API 호출
    # import requests
    # response = requests.get(f"http://internal-api/lots?fab={fab}")
    # lot_data = response.json()
    
    if not lot_data:
        return "LOT 데이터를 조회할 수 없습니다."
    
    # 기존 분석 로직 유지...
```

### **데이터베이스 연동 (필요시)**
**파일**: `app/core/config.py` (29-33줄)

```python
# 현재: 주석 처리된 상태
# M14_DB_URL: str = os.getenv("M14_DB_URL", "")
# M15_DB_URL: str = os.getenv("M15_DB_URL", "")  
# M16_DB_URL: str = os.getenv("M16_DB_URL", "")

# 실제 사용시 주석 해제 후 수정
M14_DB_URL: str = os.getenv("M14_DB_URL", "oracle://user:pass@mes-db-m14:1521/M14")
M15_DB_URL: str = os.getenv("M15_DB_URL", "postgresql://user:pass@mes-db-m15:5432/M15")
M16_DB_URL: str = os.getenv("M16_DB_URL", "mysql://user:pass@mes-db-m16:3306/M16")
```

---

## 🚀 **4단계: 배포 및 운영**

### **환경별 설정**
```bash
# 개발 환경
export OPENAI_MODEL="gpt-3.5-turbo"
export DEBUG="true"
export LOG_LEVEL="DEBUG"

# 운영 환경  
export OPENAI_MODEL="gpt-4"
export DEBUG="false"
export LOG_LEVEL="INFO"
```

### **서비스 실행**
```bash
# 개발 모드
python -m uvicorn app.main:app --reload --port 8000

# 운영 모드
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
```

### **헬스 체크 및 모니터링**
```bash
# 서비스 상태 확인
curl http://localhost:8000/health

# AI 분석 테스트
curl -X POST http://localhost:8000/api/analyze/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "현재 M14 라인 LOT 상황을 분석해줘",
    "agentType": "lot", 
    "context": {
      "pageType": "lot_history",
      "totalCount": 15,
      "selectedFab": "M14"
    }
  }'
```

---

## ⚠️ **주의사항 및 베스트 프랙티스**

### **🔐 보안**
- [ ] API 키를 코드에 하드코딩 금지
- [ ] 환경변수 또는 보안 저장소 사용
- [ ] 운영 환경에서 DEBUG 모드 비활성화
- [ ] CORS 설정을 운영 도메인으로 제한

### **💰 비용 관리**
- [ ] OpenAI API 사용량 모니터링 설정
- [ ] 월 예산 한도 설정 (OpenAI 대시보드)
- [ ] gpt-3.5-turbo 사용 고려 (gpt-4 대비 10배 저렴)
- [ ] MAX_TOKENS 제한으로 비용 절약

### **🔧 성능 최적화**
- [ ] 컨텍스트 데이터 크기 제한 (토큰 한계 고려)
- [ ] 캐싱 시스템 도입 (동일 질문 반복 방지)
- [ ] 응답 시간 모니터링 및 최적화
- [ ] 동시 요청 수 제한 설정

### **📊 모니터링**
- [ ] 로그 레벨 적절히 설정 (운영: INFO, 개발: DEBUG)
- [ ] API 응답 시간 모니터링
- [ ] 에러율 추적 및 알림 설정
- [ ] 사용량 통계 수집

---

## 🆘 **문제 해결 가이드**

### **자주 발생하는 문제**

#### **1. OpenAI API 키 오류**
```bash
# 증상: "OpenAI API 키가 설정되지 않았습니다" 오류
# 해결: API 키 확인 및 재설정
echo $OPENAI_API_KEY  # 환경변수 확인
export OPENAI_API_KEY="sk-your-key"  # 재설정
```

#### **2. CORS 오류**
```bash  
# 증상: 브라우저에서 "CORS policy" 오류
# 해결: config.py의 ALLOWED_ORIGINS에 도메인 추가
```

#### **3. 토큰 제한 오류**
```bash
# 증상: "maximum context length" 오류
# 해결: MAX_TOKENS 값 조정 또는 컨텍스트 데이터 크기 축소
```

#### **4. 응답 시간 지연**
```bash
# 증상: AI 응답이 너무 느림 (30초 이상)
# 해결: AGENT_TIMEOUT 값 조정 또는 프롬프트 최적화
```

---

## 📞 **지원 및 연락처**

- **기술 지원**: AI 개발팀 (내선: XXXX)
- **운영 문의**: IT 운영팀 (내선: YYYY)  
- **비용 관련**: 구매팀 (내선: ZZZZ)

---

**📅 최종 수정일**: 2024년 XX월 XX일  
**📝 작성자**: AI MES 개발팀  
**🔄 버전**: v1.0
