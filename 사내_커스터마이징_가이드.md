# AI MES 시스템 사내 커스터마이징 가이드

## 📋 개요

이 문서는 AI MES 시스템을 사내 환경에 맞게 커스터마이징하기 위한 종합 가이드입니다. 
현재 시스템은 M14/M15/M16 FAB을 대상으로 한 반도체 MES 시스템으로 구성되어 있으며, 
3개 모듈(Backend, Frontend, AI Service)로 분리되어 있습니다.

## 🏗️ 시스템 아키텍처

```
Frontend (Next.js) ──→ Backend (Spring Boot) ──→ Database (PostgreSQL)
      ↓                        ↓
   AI Service (FastAPI) ←──────┘
```

## 📊 현재 데이터 구조 분석

### Lot 데이터 (현재 구조)
- `id`: 고유 식별자
- `lot_number`: 로트 번호
- `product`: 제품명
- `fab`: FAB 구분 (M14/M15/M16)
- `status`: 상태 (completed/in_progress/waiting/error)
- `start_time`: 시작 시간
- `end_time`: 종료 시간
- `step`: 공정 단계
- `equipment`: 설비명
- `progress`: 진행률 (%)
- `estimated_completion`: 예상 완료 시간
- `duration`: 소요 시간
- `result`: 결과 (normal/delayed/error)

### Equipment 데이터 (현재 구조)
- `id`: 고유 식별자
- `equipment_id`: 설비 ID
- `equipment_name`: 설비명
- `fab`: FAB 구분
- `status`: 상태 (running/idle/maintenance/error)
- `current_operation`: 현재 작업
- `current_lot`: 현재 로트
- `utilization`: 가동률 (%)
- `temperature`: 온도
- `pressure`: 압력
- `alerts`: 알림 수

### Return 데이터 (현재 구조)
- `id`: 고유 식별자
- `return_id`: 리턴 ID
- `lot_number`: 로트 번호
- `product`: 제품명
- `fab`: FAB 구분
- `return_reason`: 리턴 사유
- `return_step`: 리턴 공정
- `return_date`: 리턴 날짜
- `return_by`: 리턴 담당자
- `target_step`: 목표 공정
- `status`: 상태 (resolved/processing/analyzing)
- `severity`: 심각도 (High/Medium/Low)

---

# 🔧 1. Backend 커스터마이징 가이드

## 1.1 데이터베이스 스키마 변경

### 📍 위치
- `backend/src/main/resources/mapper/`
- 각 FAB별로 분리된 매퍼 파일 (m14/, m15/, m16/)

### 🔄 수정 방법

#### 1.1.1 테이블 구조 변경
```xml
<!-- 예시: LotDataMapper.xml -->
<resultMap id="LotDataResultMap" type="com.ai.mes.model.LotData">
    <!-- 기존 컬럼 -->
    <id column="id" property="id" />
    <result column="lot_number" property="lotNumber" />
    
    <!-- 새로운 컬럼 추가 예시 -->
    <result column="사내_컬럼명1" property="customField1" />
    <result column="사내_컬럼명2" property="customField2" />
</resultMap>
```

#### 1.1.2 쿼리 수정
```xml
<!-- SELECT 쿼리 수정 -->
<select id="selectAll" resultMap="LotDataResultMap">
    SELECT *, 사내_컬럼명1, 사내_컬럼명2 
    FROM 사내_테이블명 
    ORDER BY created_at DESC
</select>

<!-- INSERT 쿼리 수정 -->
<insert id="insert" parameterType="com.ai.mes.model.LotData">
    INSERT INTO 사내_테이블명 (
        id, lot_number, 사내_컬럼명1, 사내_컬럼명2
    ) VALUES (
        #{id}, #{lotNumber}, #{customField1}, #{customField2}
    )
</insert>
```

## 1.2 모델 클래스 수정

### 📍 위치
- `backend/src/main/java/com/ai/mes/model/`

### 🔄 수정 방법
```java
// LotData.java 예시
@Data
@NoArgsConstructor
@AllArgsConstructor
public class LotData {
    // 기존 필드들
    private String id;
    private String lotNumber;
    
    // 사내 커스텀 필드 추가
    private String customField1;
    private String customField2;
    private Integer customNumericField;
    private LocalDateTime customDateField;
}
```

## 1.3 데이터베이스 연결 설정

### 📍 위치
- `backend/src/main/resources/application.yml`

### 🔄 수정 방법
```yaml
spring:
  datasource:
    # 사내 M14 FAB Database
    m14:
      jdbc-url: ${사내_M14_DB_URL}
      username: ${사내_M14_DB_USERNAME}
      password: ${사내_M14_DB_PASSWORD}
      driver-class-name: org.postgresql.Driver  # 또는 사내 DB 드라이버
      
    # 사내 M15 FAB Database  
    m15:
      jdbc-url: ${사내_M15_DB_URL}
      username: ${사내_M15_DB_USERNAME}
      password: ${사내_M15_DB_PASSWORD}
      
    # 사내 M16 FAB Database
    m16:
      jdbc-url: ${사내_M16_DB_URL}
      username: ${사내_M16_DB_USERNAME}
      password: ${사내_M16_DB_PASSWORD}
```

## 1.4 API 엔드포인트 수정

### 📍 위치
- `backend/src/main/java/com/ai/mes/controller/`

### 🔄 수정 방법
```java
@RestController
@RequestMapping("/api/lot")
public class LotController {
    
    // 사내 요구사항에 맞는 새로운 엔드포인트 추가
    @GetMapping("/사내_특별_조회")
    public ResponseEntity<ApiResponse<List<LotData>>> getCustomLotData(
            @RequestParam String customParam1,
            @RequestParam String customParam2) {
        
        List<LotData> result = lotService.getCustomData(customParam1, customParam2);
        return ResponseEntity.ok(ApiResponse.success(result));
    }
}
```

---

# 🎨 2. Frontend 커스터마이징 가이드

## 2.1 타입 정의 수정

### 📍 위치
- `frontend/src/types/index.ts`

### 🔄 수정 방법
```typescript
// 사내 요구사항에 맞는 타입 수정
export interface LotData {
  id: string;
  lotNumber: string;
  product: string;
  fab: FabType;
  
  // 기존 필드들...
  status: 'completed' | 'in_progress' | 'waiting' | 'error';
  
  // 사내 커스텀 필드 추가
  customField1?: string;
  customField2?: string;
  customNumericField?: number;
  customDateField?: string;
}

// 사내 FAB 타입 수정
export type FabType = '사내FAB1' | '사내FAB2' | '사내FAB3';

// 사내 상태값 수정
export interface LotStatus {
  status: '사내상태1' | '사내상태2' | '사내상태3' | '사내상태4';
}
```

## 2.2 화면 컴포넌트 수정

### 📍 위치
- `frontend/src/app/lot/status/page.tsx`
- `frontend/src/app/equipment/status/page.tsx`
- `frontend/src/app/return/history/page.tsx`

### 🔄 수정 방법
```typescript
// 예시: Lot Status 페이지 커스터마이징
export default function LotStatusPage() {
  // 사내 데이터 구조에 맞는 인터페이스 수정
  interface LotStatus {
    id: string;
    lotNumber: string;
    product: string;
    fab: string;
    currentStep: string;
    equipment: string;
    progress: number;
    
    // 사내 커스텀 필드
    customField1: string;
    customField2: string;
    사내필드명: string;
  }

  // Mock 데이터를 사내 데이터 형태로 수정
  useEffect(() => {
    const mockData: LotStatus[] = [
      {
        id: '1',
        lotNumber: '사내로트번호001',
        product: '사내제품A',
        fab: '사내FAB1',
        currentStep: '사내공정명1',
        equipment: '사내설비001',
        progress: 85,
        customField1: '사내값1',
        customField2: '사내값2',
        사내필드명: '사내데이터'
      }
    ];
    setLotStatuses(mockData);
  }, []);

  return (
    <div className="container mx-auto px-4 py-8">
      {/* 사내 요구사항에 맞는 UI 수정 */}
      <h1>사내 로트 상태 모니터링</h1>
      
      {/* 사내 커스텀 필드 표시 */}
      {lotStatuses.map((lot) => (
        <div key={lot.id}>
          <div>사내필드: {lot.사내필드명}</div>
          <div>커스텀1: {lot.customField1}</div>
          <div>커스텀2: {lot.customField2}</div>
        </div>
      ))}
    </div>
  );
}
```

## 2.3 API 클라이언트 수정

### 📍 위치
- `frontend/src/api/`

### 🔄 수정 방법
```typescript
// 예시: lot.ts 수정
import { ApiResponse, LotData } from '@/types';

export const lotApi = {
  // 기존 API들...
  
  // 사내 커스텀 API 추가
  getCustomLotData: async (customParam1: string, customParam2: string): Promise<LotData[]> => {
    const response = await fetch(`/api/backend/lot/사내_특별_조회?customParam1=${customParam1}&customParam2=${customParam2}`);
    const result: ApiResponse<LotData[]> = await response.json();
    
    if (!result.success) {
      throw new Error(result.message || '사내 데이터 조회 실패');
    }
    
    return result.data;
  }
};
```

---

# 🤖 3. AI Service 커스터마이징 가이드

## 3.1 데이터 스키마 수정

### 📍 위치
- `ai-service/app/models/schemas.py`

### 🔄 수정 방법
```python
from pydantic import BaseModel
from typing import Optional, List, Any, Dict
from datetime import datetime

class LotData(BaseModel):
    id: str
    lot_number: str
    product: str
    fab: str
    status: str
    
    # 기존 필드들...
    start_time: Optional[datetime] = None
    end_time: Optional[datetime] = None
    step: str
    equipment: str
    progress: Optional[int] = None
    
    # 사내 커스텀 필드 추가
    custom_field1: Optional[str] = None
    custom_field2: Optional[str] = None
    custom_numeric_field: Optional[int] = None
    custom_date_field: Optional[datetime] = None
    사내_필드명: Optional[str] = None

class AnalysisRequest(BaseModel):
    context: str
    data: Optional[Dict[str, Any]] = None
    type: str  # 사내_분석타입1, 사내_분석타입2, 등으로 수정
    fab: Optional[str] = None
    
    # 사내 커스텀 분석 파라미터
    custom_analysis_param: Optional[str] = None
```

## 3.2 에이전트 로직 수정

### 📍 위치
- `ai-service/app/agents/lot_agent.py`
- `ai-service/app/agents/equipment_agent.py`
- `ai-service/app/agents/return_agent.py`

### 🔄 수정 방법
```python
# 예시: lot_agent.py 수정
class LotAgent(BaseAgent):
    def __init__(self):
        super().__init__()
        self.agent_type = "lot"
        
        # 사내 특화 프롬프트 템플릿
        self.system_prompt = """
        당신은 사내 MES 시스템의 Lot 분석 전문가입니다.
        
        사내 특화 분석 기준:
        - 사내_필드명을 기준으로 우선순위 분석
        - custom_field1, custom_field2 값에 따른 특별 처리
        - 사내 FAB별 특화 분석 로직 적용
        
        분석 결과는 반드시 한국어로 제공하며, 
        사내 용어와 기준을 사용하여 설명하세요.
        """

    def create_analysis_prompt(self, context: str, data: dict = None) -> str:
        prompt = f"""
        사내 Lot 데이터 분석을 수행합니다.

        분석 컨텍스트: {context}
        
        사내 특화 분석 항목:
        1. 사내_필드명 기준 분석
        2. custom_field1, custom_field2 상관관계 분석
        3. 사내 FAB별 특성 고려
        4. 사내 기준 임계값 적용
        
        데이터: {data if data else "데이터 없음"}
        
        다음 형식으로 분석 결과를 제공하세요:
        
        ## 현재 상황 요약
        - 사내 기준 상태 평가
        
        ## 주요 발견사항
        - 사내 특화 이슈 식별
        
        ## 권장사항
        - 사내 프로세스 기반 개선안
        
        ## 알림사항
        - 사내 기준 임계값 초과 항목
        """
        
        return prompt
```

## 3.3 분석 서비스 수정

### 📍 위치
- `ai-service/app/services/analysis_service.py`

### 🔄 수정 방법
```python
class AnalysisService:
    def __init__(self):
        self.lot_agent = LotAgent()
        self.equipment_agent = EquipmentAgent()
        self.return_agent = ReturnAgent()
        
        # 사내 특화 설정
        self.company_config = {
            "fab_mapping": {
                "사내FAB1": "M14",
                "사내FAB2": "M15", 
                "사내FAB3": "M16"
            },
            "custom_thresholds": {
                "사내_임계값1": 85,
                "사내_임계값2": 95
            }
        }

    async def analyze(self, request: AnalysisRequest) -> AnalysisResponse:
        try:
            # 사내 데이터 전처리
            processed_data = self._preprocess_company_data(request.data)
            
            # 사내 분석 타입별 처리
            if request.type == "사내_분석타입1":
                result = await self._company_analysis_type1(request.context, processed_data)
            elif request.type == "사내_분석타입2":
                result = await self._company_analysis_type2(request.context, processed_data)
            else:
                # 기본 분석 로직
                result = await self._default_analysis(request.context, processed_data)
            
            return AnalysisResponse(
                analysis=result["analysis"],
                recommendations=result.get("recommendations", []),
                alerts=result.get("alerts", []),
                timestamp=datetime.now()
            )
            
        except Exception as e:
            logger.error(f"사내 분석 오류: {str(e)}")
            raise

    def _preprocess_company_data(self, data: dict) -> dict:
        """사내 데이터 형식에 맞게 전처리"""
        if not data:
            return {}
            
        # 사내 필드명 매핑
        processed = {}
        for key, value in data.items():
            if key in self.company_config.get("field_mapping", {}):
                processed[self.company_config["field_mapping"][key]] = value
            else:
                processed[key] = value
                
        return processed
```

---

# 🔄 4. 통합 커스터마이징 체크리스트

## 4.1 데이터베이스 변경사항
- [ ] 사내 테이블명 확인 및 매퍼 파일 수정
- [ ] 사내 컬럼명 확인 및 resultMap 수정
- [ ] 사내 데이터 타입 확인 및 모델 클래스 수정
- [ ] 사내 DB 연결 정보 설정 (application.yml)
- [ ] 사내 쿼리 로직 검토 및 수정

## 4.2 API 변경사항
- [ ] 사내 요구사항에 맞는 엔드포인트 추가/수정
- [ ] 사내 파라미터 검증 로직 추가
- [ ] 사내 응답 형식 맞춤 수정
- [ ] 사내 권한/보안 정책 적용

## 4.3 화면 변경사항
- [ ] 사내 화면 레이아웃 요구사항 반영
- [ ] 사내 용어 및 라벨 변경
- [ ] 사내 컬럼 추가/제거/순서 변경
- [ ] 사내 색상/테마 적용
- [ ] 사내 필터링/정렬 기준 적용

## 4.4 AI 분석 변경사항
- [ ] 사내 분석 기준 및 임계값 설정
- [ ] 사내 특화 프롬프트 작성
- [ ] 사내 용어 및 도메인 지식 반영
- [ ] 사내 알림 기준 설정

---

# 🚀 5. 배포 및 테스트 가이드

## 5.1 개발 환경 설정
```bash
# 1. 환경 변수 설정 (.env.local)
사내_M14_DB_URL=jdbc:postgresql://사내서버:5432/사내db명
사내_M14_DB_USERNAME=사내계정
사내_M14_DB_PASSWORD=사내비밀번호

# 2. 의존성 설치 및 빌드
cd backend && mvn clean install
cd frontend && npm install && npm run build
cd ai-service && pip install -r requirements.txt

# 3. 각 모듈 실행
# Backend
cd backend && mvn spring-boot:run

# Frontend  
cd frontend && npm run dev

# AI Service
cd ai-service && python app/main.py
```

## 5.2 테스트 시나리오
1. **데이터 연동 테스트**
   - 사내 DB 연결 확인
   - 사내 데이터 조회 확인
   - 사내 필드 매핑 확인

2. **화면 표시 테스트**
   - 사내 컬럼 표시 확인
   - 사내 용어 표시 확인
   - 사내 레이아웃 확인

3. **AI 분석 테스트**
   - 사내 데이터 기반 분석 확인
   - 사내 기준 임계값 적용 확인
   - 사내 용어 응답 확인

---

# 📞 6. 지원 및 문의

커스터마이징 과정에서 문제가 발생하거나 추가 지원이 필요한 경우:

1. **기술 문의**: 각 모듈별 담당자에게 문의
2. **데이터 이슈**: 사내 DBA와 협의
3. **화면 요구사항**: 사내 UI/UX 담당자와 협의
4. **AI 분석 로직**: 사내 도메인 전문가와 협의

---

**⚠️ 주의사항**
- 모든 변경사항은 개발 환경에서 충분히 테스트 후 운영 환경에 적용
- 사내 보안 정책 및 데이터 거버넌스 준수
- 백업 및 롤백 계획 수립 필수
- 성능 영향도 사전 검토 필요
